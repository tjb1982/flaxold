name: Node init
description: >
    Launch a node created from a template or cloned from a base.
requires:
    - key: NODE_NAME
    - key: NODE_CONNECTOR
    - key: NODE_CONFIG
    - key: PRIVATE_IP
      default: true
    - key: FORCE
      default: false
provides:
    - key: IP_ADDRESS
    - key: SSH_PRIVATE_KEY
checkpoints:
    throw: true
    groups:
        - group:
            - nodes:
                - name: ~@NODE_NAME
                  connector: ~@NODE_CONNECTOR
                  options: ~@NODE_CONFIG
                  force: ~@FORCE
        - group:
            - nodes:
                - name: ~@NODE_NAME
              invocation: mkdir -p ~/.ssh
            - nodes:
                - name: ~@NODE_NAME
              invocation: apt-get -y install dnsutils
        - group:
            - nodes:
                - name: ~@NODE_NAME
                  out: IP_ADDRESS
              invocation:
                ~(if:
                    - ~@PRIVATE_IP
                    - hostname -I
                    - dig +short myip.opendns.com @resolver1.opendns.com
            - nodes:
                - name: ~@NODE_NAME
              throw: false
              invocation: echo -e "\n\n\n" | ssh-keygen -t rsa -N "" -f ~/.ssh/flax_id_rsa
        - group:
            - nodes:
                - name: ~@NODE_NAME
                  out: SSH_PRIVATE_KEY
              invocation: cat ~/.ssh/flax_id_rsa
              log: false

