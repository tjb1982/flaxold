name: Spock basic provision
requires:
    - key: OPSC_HOME
      description: the path to the ripcord repository, which contains the spock functional tests
    - key: SPOCK_PUBLIC_IP
      description: the public ip-addr for the node on which spock is running
    - key: TARGET_IPS
      description: comma-separated list of ips to be used as target nodes
    - key: TARGET_SSH_PRIVATE_KEY
      description: string containing the complete id_rsa private key shared by all target nodes
    - key: TARGET_SSH_PORT
      description: the port to use for ssh communication from spock to the target nodes
description: >
    Tests a high level "demo" path using an ssh-private-key machine credential
checkpoints:
    # applies to all checkpoints
    throw: true
    groups:
          # applies to all checkpoints in this group
        - group:
            - nodes:
                - name: ~@SPOCK_NODE_NAME
                  user: ~@SPOCK_USER
              invocation: |
                gingham/gingham.py ~{OPSC_HOME}/spock/test/functional/api-tests/demo-path.yaml \
                    -b http://~{SPOCK_HOSTNAME}:8889/api/v1 \
                    -a NODES=~{NODES} \
                    -a USERNAME=$USERNAME \
                    -a PRIVATE_KEY="$TARGET_SSH_PRIVATE_KEY" \
                    -a RETRY=250 \
                    -a DELAY=100
                 
        - group:
            - exec: >
                echo $TARGET_IPS
                | tr ',' '\n'
                | sed 's/\$\$/:$TARGET_SSH_PORT/'
                | tr '\n' ','
                | sed 's/,\$\$//'
              description: adds the ssh port to the end of the target ip-addrs
              out: TARGET_IPS_WITH_SSH_PORT
            - exec: whoami
              out: USERNAMES
              delimiter: ","
              cluster: TARGET_CLUSTER_NAME
        - group:
            - exec: echo $USERNAMES | tr ',' '\n' | head -n 1
              out: USERNAME
        - throw: true
          group:
              # applies to this checkpoint only
            - description: >
                Tests a spock happy, demo path, where machine credentials, a config profile,
                cluster, and datacenter are created. Then three nodes are configured with the
                same cluster config and data center id. Then an "install" job is created and
                a variety of GETs are done to verify the actions taken.
              exec: |
                gingham/gingham.py $OPSC_HOME/spock/test/functional/api-tests/demo-path.yaml \
                    -b http://$SPOCK_PUBLIC_IP:8889/api/v1 \
                    -a NODES=$(echo "$TARGET_IPS_WITH_SSH_PORT") \
                    -a USERNAME=$USERNAME \
                    -a PRIVATE_KEY="$TARGET_SSH_PRIVATE_KEY" \
                    -a RETRY=250 \
                    -a DELAY=100

