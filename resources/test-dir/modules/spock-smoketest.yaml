name: Spock smoketests
description: >
    Runs a couple of smoketests to verify that spock is running as expected.
requires:
    - key: SPOCK_NODE_NAME
      description: >
        The name of the node that hosts the spock service.
    - key: SPOCK_HOSTNAME
      default: localhost
    - key: OPSC_HOME
      description: >
        The path to the ripcord repo where the spock lib resides on the machine
        hosting this application (i.e., localhost).
    - key: GITHUB_PRIVATE_KEY
    - key: SPOCK_USER
      default: flax
checkpoints:
    # applies to all checkpoints
    throw: true
    groups:
        - group:
            # TODO: these smoketests should run on localhost and should be broken into their own module maybe.
            - nodes:
                - &spock_user_node
                  name: ~@SPOCK_NODE_NAME
                  user: ~@SPOCK_USER
              description: >
                A smoke test that pings Spock at the api base. Checks n times
                every m seconds before reporting a failure, so that the spock
                service has a chance to start up completely.
              invocation: ~{OPSC_HOME}/spock/test/functional/smoketests/smoke-test.sh ~{SPOCK_HOSTNAME}:8889/api/ 20 2
        - group:
            - nodes:
                - *spock_user_node
              description: >
                A smoke test that tries the /provisioning/datacenters/ endpoint,
                waiting 5 seconds for a response
              invocation: |
                ~{OPSC_HOME}/spock/test/functional/smoketests/smoke-test.py ~{SPOCK_HOSTNAME}

