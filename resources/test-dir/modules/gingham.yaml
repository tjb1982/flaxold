name: Gingham API tests
requires:
    - key: TEST
      description: >
        A path to the test gingham will run.
    - key: BASE
      description: >
        The API base relative to where the gingham endpoint functions point.
        - key: NODE_NAME
        - key: NODE_USER
description: >
    General API test module.
checkpoints:
    groups:
        - throw: false
          group:
              - nodes:
                  - name: ~@NODE_NAME
                    user: root
                invocation: pip install pyyaml
        - throw: true
          group:
              - nodes:
                  - name: ~@NODE_NAME
                    user: ~@NODE_USER
                description: >
                    A more or less thorough functional test of the /provisioning/repository_credentials/ endpoint.
                invocation: |
                    cd ~
                    eval "$(ssh-agent -s)"
                    ssh-add ~/.ssh/id_rsa
                    ssh -T git@github.com -o StrictHostKeyChecking=no

                    if [ ! -d gingham ]; then
                        git clone git@github.com:tjb1982/gingham.git
                    fi

                    gingham/gingham.py ~{TEST} -b ~{BASE}

