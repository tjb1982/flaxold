name: Spock functional test program
const:
    - &node_init ~{TEST_DIR}/modules/node-init.yaml
main:
    - ~(str:
        - foo
        - " "
        - bar
    - baz
    - ~(conj:
        - []
        - quux
        - 23
    - ~(map:
        - ~(fn:
            - - idx
            - module: *node_init
              in:
                NODE_NAME: test~{idx}
              out:
                IPS:
                    ~(conj:
                        - ~@IPS
                        - ~@IP_ADDRESS
        - ~(range: [3,6]
    - ~(map:
        - ~(#:
            - module: *node_init
              in:
                NODE_NAME: test~{0}
              out:
                IPS:
                    ~(conj:
                        - ~@IPS
                        - ~@IP_ADDRESS
        - ~(range: [0,3]
      then:
        - module: *node_init
          in:
            NODE_NAME:
                ~(apply:
                     - ~(resolve:
                         - ~(symbol:
                             - str
                     - ~@IPS

#       - ~(map:
#           - ~(fn:
#               - module: *node_init
#                 in:
#                   NODE_NAME: test~{0}
#                 then:
#                   ~(if:
#                       - ~(=:
#                           - ~@0
#                           - ~(last:
#                               - ~(range: [0,3]
                   

#    - - module: ~{TEST_DIR}/modules/node-init.yaml
#        in:
#          NODE_NAME: test
#        out:
#          FOO_SNACKS: ~@IP_ADDRESS
#      - module: ~{TEST_DIR}/modules/node-init.yaml
#        in:
#          NODE_NAME: test1
#        out:
#          FOO_SNACKS1: ~@IP_ADDRESS
#        then:
#          - - module: ~{TEST_DIR}/modules/node-init.yaml
#              in:
#                NODE_NAME: test3
#            - module: ~{TEST_DIR}/modules/node-init.yaml
#              in:
#                NODE_NAME: test4
#
#    - - module: ~{TEST_DIR}/modules/node-init.yaml
#        in:
#          NODE_NAME: ~@SPOCK_NODE_NAME
#        out:
#          SPOCK_HOSTNAME: ~@IP_ADDRESS
#        then:
#          - - module: ~{TEST_DIR}/modules/spock-init.yaml
#              in:
#              then:
#                - - module: ~{TEST_DIR}/modules/spock-smoketest.yaml
#                    then:
#                      - - ~(for:
#                            - - test
#                              - - ~{OPSC_HOME}/spock/test/functional/api-tests/repository-credentials-test.yaml
#                            - module: ~{TEST_DIR}/modules/gingham.yaml
#                              isolate: true
#                              in:
#                                TEST: ~@test
#                                BASE: http://~{SPOCK_HOSTNAME}:8889/api/v1
#                                NODE_NAME: ~@SPOCK_NODE_NAME
#                                NODE_USER: ~@SPOCK_USER
#                      - - ~(for:
#                            - - idx
#                              - ~(range:
#                                  - 0
#                                  - ~@TARGET_NODE_COUNT
#                            - module: ~{TEST_DIR}/modules/node-init.yaml
#                              in:
#                                NODE_NAME: t~{idx}
#                                FORCE: true
#                              out:
#                                TARGET_PRIVATE_KEYS:
#                                    ~(conj:
#                                        - ~@TARGET_PRIVATE_KEYS
#                                        - ~@SSH_PRIVATE_KEY
#                                TARGETS_SSH:
#                                    ~(conj:
#                                        - ~@TARGETS_SSH
#                                        - ~(str:
#                                            - ~(clojure.string/trim:
#                                                - ~@IP_ADDRESS
#                                            - ":22"
#                          then:
#                            - - module: ~{TEST_DIR}/modules/gingham.yaml
#                                in:
#                                  TEST: ~{OPSC_HOME}/spock/test/functional/api-tests/demo-path.yaml
#                                  BASE: http://~{SPOCK_HOSTNAME}:8889/api/v1
#                                  NODE_NAME: ~@SPOCK_NODE_NAME
#                                  NODE_USER: ~@SPOCK_USER
#                                  KWARGS:
#                                      - key: NODES
#                                        val:
#                                          ~(clojure.string/join:
#                                              - ","
#                                              - ~@TARGETS_SSH
#                                      - key: USERNAME
#                                        val: ~@SPOCK_USER
#                                      - key: PRIVATE_KEY
#                                        val:
#                                          ~(first:
#                                              - ~@TARGET_PRIVATE_KEYS
#                                      - key: RETRY
#                                        val: 250
#                                      - key: DELAY
#                                        val: 100
#
