name: Spock functional test program
_modules:
    - &node-init ~{TEST_DIR}/modules/node-init.yaml
    - &spock-init ~{TEST_DIR}/modules/spock-init.yaml
    - &spock-smoketest ~{TEST_DIR}/modules/spock-smoketest.yaml
    - &gingham ~{TEST_DIR}/modules/gingham.yaml
_vars:
    - &spock_node
      NODE_NAME: ~@SPOCK_NODE_NAME
      NODE_USER: ~@SPOCK_USER
main:
    - module: *node-init
      in:
        NODE_NAME: ~@SPOCK_NODE_NAME
      out:
        SPOCK_HOSTNAME: ~@IP_ADDRESS
      then:
        - module: *spock-init
          in:
          then:
            - module: *spock-smoketest
              then:
                - ~(map:
                    - ~(#:
                        - module: *gingham
                          isolate: true
                          in:
                            TEST: ~@0
                            BASE: http://~{SPOCK_HOSTNAME}:8889/api/v1
                            <<: *spock_node
                    - ~@API_TESTS
                - ~(pmap:
                    - ~(#:
                        - module: *node-init
                          in:
                            NODE_NAME: t~{0}
                            FORCE: true
                          out:
                            TARGETS:
                                ~(conj:
                                    - ~@TARGETS_SSH
                                    - ~@IP_ADDRESS
                    - ~(range:
                        - 0
                        - ~@TARGET_NODE_COUNT
                  then:
                    - module: *gingham
                      in:
                        TEST: ~{OPSC_HOME}/spock/test/functional/api-tests/demo-path.yaml
                        BASE: http://~{SPOCK_HOSTNAME}:8889/api/v1
                        <<: *spock_node
                        KWARGS:
                            - key: NODES
                              val:
                                ~(clojure.string/join:
                                    - ","
                                    - ~@TARGETS_SSH
                            - key: USERNAME
                              val: ~@SPOCK_USER
                            - key: PRIVATE_KEY
                              val: ~{HOME}/.ssh/id_rsa
                            - key: RETRY
                              val: 250
                            - key: DELAY
                              val: 100

